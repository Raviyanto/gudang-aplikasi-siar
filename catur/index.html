<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Siar Hacker Chess</title>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <style>
        :root { --neon: #39ff14; --bg: #000; --dim: rgba(57, 255, 20, 0.1); }
        body { 
            background: var(--bg); color: var(--neon); font-family: 'Courier New', monospace; 
            margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh;
        }
        .header { margin-bottom: 20px; text-align: center; }
        
        /* Papan Catur Neon */
        .board {
            display: grid; grid-template-columns: repeat(8, 60px); grid-template-rows: repeat(8, 60px);
            border: 4px solid var(--neon); box-shadow: 0 0 20px var(--dim);
        }
        .square {
            width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;
            font-size: 40px; cursor: pointer; transition: 0.2s;
        }
        .black { background-color: #052d05; }
        .white { background-color: #000; }
        .selected { background-color: var(--neon) !important; color: #000; }
        .highlight { box-shadow: inset 0 0 10px var(--neon); }

        .btn-exit {
            margin-top: 30px; padding: 10px 20px; border: 1px solid #f33; color: #f33;
            background: none; cursor: pointer; font-family: inherit; font-weight: bold;
        }
        .btn-exit:hover { background: #f33; color: #000; }
    </style>
</head>
<body>

    <div class="header">
        <h1 style="letter-spacing: 5px;">SIAR_CHESS_V1</h1>
        <div id="status">GILIRAN: PUTIH</div>
    </div>

    <div class="board" id="board"></div>

    <button class="btn-exit" onclick="toko.buka_aplikasi_siar('dashboard')">KELUAR_KE_DASHBOARD</button>

    <script>
        let game = new Chess();
        let selectedSquare = null;
        let toko;

        // Inisialisasi Jalur Komunikasi ke Otak
        new QWebChannel(qt.webChannelTransport, function(channel) {
            toko = channel.objects.tokoManager;
        });

        function renderBoard() {
            const boardElement = document.getElementById('board');
            boardElement.innerHTML = '';
            
            const squares = game.SQUARES;
            // Chess.js urutannya a8 ke h1, kita sesuaikan tampilannya
            const rows = [8,7,6,5,4,3,2,1];
            const cols = ['a','b','c','d','e','f','g','h'];

            rows.forEach(row => {
                cols.forEach(col => {
                    const squareId = col + row;
                    const piece = game.get(squareId);
                    const div = document.createElement('div');
                    
                    div.className = `square ${(rows.indexOf(row) + cols.indexOf(col)) % 2 === 0 ? 'white' : 'black'}`;
                    div.id = squareId;
                    
                    if (piece) {
                        div.innerText = getPieceUnicode(piece);
                    }

                    if (selectedSquare === squareId) div.classList.add('selected');

                    div.onclick = () => handleSquareClick(squareId);
                    boardElement.appendChild(div);
                });
            });

            document.getElementById('status').innerText = `GILIRAN: ${game.turn() === 'w' ? 'PUTIH' : 'HITAM'}`;
        }

        function getPieceUnicode(piece) {
            const icons = {
                'p': '♟', 'r': '♜', 'n': '♞', 'b': '♝', 'q': '♛', 'k': '♚',
                'P': '♙', 'R': '♖', 'N': '♘', 'B': '♗', 'Q': '♕', 'K': '♔'
            };
            return icons[piece.type === piece.type.toLowerCase() ? piece.type : piece.type.toUpperCase()];
        }

        function handleSquareClick(squareId) {
            if (selectedSquare === null) {
                if (game.get(squareId)) {
                    selectedSquare = squareId;
                    renderBoard();
                }
            } else {
                let move = game.move({ from: selectedSquare, to: squareId, promotion: 'q' });
                if (move === null) {
                    // Jika klik bidak lain milik sendiri, ganti seleksi
                    if (game.get(squareId) && game.get(squareId).color === game.get(selectedSquare).color) {
                        selectedSquare = squareId;
                    } else {
                        selectedSquare = null;
                    }
                } else {
                    selectedSquare = null;
                    if (game.game_over()) alert("PERMAINAN SELESAI!");
                }
                renderBoard();
            }
        }

        renderBoard();
    </script>
</body>
</html>
