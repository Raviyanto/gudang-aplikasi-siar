<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Siar Hacker Chess AI Pro</title>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <style>
        :root { --neon: #39ff14; --bg: #000; --dim: rgba(57, 255, 20, 0.1); }
        * { box-sizing: border-box; }
        
        /* FIX LAYOUT */
        body { 
            background: var(--bg) !important; color: var(--neon); 
            font-family: 'Courier New', monospace; margin: 0; padding: 5px;
            display: flex; flex-direction: column; align-items: center; 
            justify-content: center; height: 100vh; width: 100vw; overflow: hidden;
        }

        .header { text-align: center; margin-bottom: 5px; flex-shrink: 0; }
        .mode-selector { display: flex; gap: 5px; margin-bottom: 5px; }
        
        /* Ukuran Board Dinamis agar tidak terpotong bawah */
        .board {
            display: grid; 
            grid-template-columns: repeat(8, min(10vh, 55px)); 
            grid-template-rows: repeat(8, min(10vh, 55px));
            border: 3px solid var(--neon); box-shadow: 0 0 15px var(--dim);
        }

        .square {
            width: 100%; height: 100%; display: flex; align-items: center; 
            justify-content: center; font-size: min(6vh, 35px); cursor: pointer;
        }
        .black-sq { background-color: #051a05; }
        .white-sq { background-color: #000000; }

        .piece-w { color: #ffffff !important; text-shadow: 0 0 10px #fff !important; }
        .piece-b { color: var(--neon) !important; text-shadow: 0 0 10px var(--neon) !important; }
        .selected { background-color: var(--neon) !important; color: #000 !important; }
        
        .status-box { 
            margin-top: 5px; padding: 2px 15px; border: 1px solid var(--neon); 
            font-weight: bold; font-size: 0.9rem; text-align: center;
        }

        .btn {
            background: none; border: 1px solid var(--neon); color: var(--neon);
            padding: 5px 10px; cursor: pointer; font-family: inherit; font-size: 0.8rem;
        }
        .btn.active { background: var(--neon); color: #000; }
        .btn-exit { margin-top: 5px; border-color: #f33; color: #f33; flex-shrink: 0; }
    </style>
</head>
<body>

    <div class="header">
        <h2 style="letter-spacing: 3px; margin: 0; font-size: 1.2rem;">SIAR_CHESS_PRO</h2>
        <div class="mode-selector">
            <button id="btnPvP" class="btn active" onclick="setMode('PvP')">MANUSIA</button>
            <button id="btnPvE" class="btn" onclick="setMode('PvE')">ROBOT_PRO</button>
        </div>
        <div id="status" class="status-box">SIAP</div>
    </div>

    <div class="board" id="board"></div>

    <button class="btn-exit" onclick="toko.buka_aplikasi_siar('dashboard')">KELUAR</button>

    <script>
        let game = new Chess();
        let selectedSquare = null;
        let gameMode = 'PvP';
        let toko;
        const AI_DEPTH = 3; // IQ Ditingkatkan

        new QWebChannel(qt.webChannelTransport, function(channel) {
            toko = channel.objects.tokoManager;
            renderBoard();
        });

        // Tabel Strategi Posisi (Pawn, Knight)
        const pst = {
            p: [ [0,0,0,0,0,0,0,0],[5,5,5,5,5,5,5,5],[1,1,2,3,3,2,1,1],[0.5,0.5,1,2.5,2.5,1,0.5,0.5],[0,0,0,2,2,0,0,0],[0.5,-0.5,-1,0,0,-1,-0.5,0.5],[0.5,1,1,-2,-2,1,1,0.5],[0,0,0,0,0,0,0,0] ],
            n: [ [-5,-4,-3,-3,-3,-3,-4,-5],[-4,-2,0,0,0,0,-2,-4],[-3,0,1,1.5,1.5,1,0,-3],[-3,0.5,1.5,2,2,1.5,0.5,-3],[-3,0,1.5,2,2,1.5,0,-3],[-3,0.5,1,1.5,1.5,1,0.5,-3],[-4,-2,0,0.5,0.5,0,-2,-4],[-5,-4,-3,-3,-3,-3,-4,-5] ]
        };

        function evaluateBoard(game) {
            let total = 0;
            const board = game.board();
            const weights = { p: 10, n: 30, b: 30, r: 50, q: 90, k: 900 };

            for(let i=0; i<8; i++) {
                for(let j=0; j<8; j++) {
                    const p = board[i][j];
                    if(p) {
                        let val = weights[p.type];
                        // Bonus posisi untuk Pion dan Kuda
                        if(pst[p.type]) val += pst[p.type][p.color === 'w' ? 7-i : i][j];
                        total += (p.color === 'w' ? -val : val);
                    }
                }
            }
            return total;
        }

        function minimax(depth, game, alpha, beta, isMax) {
            if (depth === 0 || game.game_over()) return evaluateBoard(game);
            const moves = game.moves();
            if (isMax) {
                let best = -Infinity;
                for (let m of moves) {
                    game.move(m);
                    best = Math.max(best, minimax(depth - 1, game, alpha, beta, false));
                    game.undo();
                    alpha = Math.max(alpha, best);
                    if (beta <= alpha) break; // Alpha-Beta Pruning
                }
                return best;
            } else {
                let best = Infinity;
                for (let m of moves) {
                    game.move(m);
                    best = Math.min(best, minimax(depth - 1, game, alpha, beta, true));
                    game.undo();
                    beta = Math.min(beta, best);
                    if (beta <= alpha) break;
                }
                return best;
            }
        }

        function makeAiMove() {
            const moves = game.moves();
            if (moves.length === 0) return;
            document.getElementById('status').innerText = "ROBOT_BERPIKIR...";

            setTimeout(() => {
                let bestMove = null;
                let bestValue = -Infinity;
                for (let m of moves) {
                    game.move(m);
                    let val = minimax(AI_DEPTH - 1, game, -Infinity, Infinity, false);
                    game.undo();
                    if (val > bestValue) { bestValue = val; bestMove = m; }
                }
                game.move(bestMove || moves[0]);
                renderBoard();
            }, 50);
        }

        function renderBoard() {
            const boardElement = document.getElementById('board');
            boardElement.innerHTML = '';
            const rows = [8,7,6,5,4,3,2,1], cols = ['a','b','c','d','e','f','g','h'];
            rows.forEach((row, rIdx) => {
                cols.forEach((col, cIdx) => {
                    const squareId = col + row;
                    const piece = game.get(squareId);
                    const div = document.createElement('div');
                    div.className = `square ${(rIdx + cIdx) % 2 === 0 ? 'white-sq' : 'black-sq'}`;
                    div.id = squareId;
                    if (piece) {
                        div.innerText = getPieceUnicode(piece);
                        div.classList.add(piece.color === 'w' ? 'piece-w' : 'piece-b');
                    }
                    if (selectedSquare === squareId) div.classList.add('selected');
                    div.onclick = () => handleSquareClick(squareId);
                    boardElement.appendChild(div);
                });
            });
            updateStatus();
        }

        function updateStatus() {
            const statusBox = document.getElementById('status');
            if (game.in_checkmate()) {
                statusBox.innerHTML = `<span style="color:#f33">SKAKMAT! MENANG: ${game.turn() === 'w' ? 'HITAM' : 'PUTIH'}</span>`;
            } else if (game.in_draw()) {
                statusBox.innerHTML = `<span style="color:#f33">SERI / REMIS</span>`;
            } else {
                const turn = game.turn() === 'w' ? '<span class="piece-w">PUTIH</span>' : '<span class="piece-b">HITAM</span>';
                statusBox.innerHTML = `GILIRAN: ${turn} ${game.in_check() ? '<b style="color:#f33"> (SKAK!)</b>' : ''}`;
            }
        }

        function setMode(mode) { gameMode = mode; game.reset(); selectedSquare = null; 
            document.getElementById('btnPvP').classList.toggle('active', mode === 'PvP');
            document.getElementById('btnPvE').classList.toggle('active', mode === 'PvE');
            renderBoard();
        }

        function getPieceUnicode(piece) {
            const icons = { p:'♟', r:'♜', n:'♞', b:'♝', q:'♛', k:'♚', P:'♙', R:'♖', N:'♘', B:'♗', Q:'♕', K:'♔' };
            return icons[piece.type];
        }

        function handleSquareClick(squareId) {
            if ((gameMode === 'PvE' && game.turn() === 'b') || game.game_over()) return;
            if (selectedSquare === null) {
                const piece = game.get(squareId);
                if (piece && piece.color === game.turn()) { selectedSquare = squareId; renderBoard(); }
            } else {
                let move = game.move({ from: selectedSquare, to: squareId, promotion: 'q' });
                selectedSquare = null; renderBoard();
                if (move && gameMode === 'PvE' && !game.game_over()) makeAiMove();
            }
        }
        renderBoard();
    </script>
</body>
</html>
